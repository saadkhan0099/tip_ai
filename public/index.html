<!-- <!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Hello, World!</title>
	</head>
	<body>
		<h1 id="heading"></h1>
		<script>
			fetch('/message')
				.then((resp) => resp.text())
				.then((text) => {
					const h1 = document.getElementById('heading');
					h1.textContent = text;
				});
		</script>
	</body>
</html> -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Arc Voice Payments</title>
    <style>
      :root {
        --blue: #007aff;
        --red: #ff3b30;
        --grey-light: #f0f2f5;
        --grey-dark: #8e8e93;
        --text-color: #1c1c1e;
        --card-bg: #ffffff;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
        display: grid;
        place-items: center;
        min-height: 100vh;
        margin: 0;
        background: var(--grey-light);
        color: var(--text-color);
      }
      .container {
        width: 90%;
        max-width: 400px;
        background: var(--card-bg);
        border-radius: 20px;
        padding: 2rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        text-align: center;
        overflow: hidden;
      }
      h1 {
        margin-top: 0;
        margin-bottom: 0.5rem;
        font-size: 1.75rem;
      }
      #status {
        margin-top: 0;
        margin-bottom: 2rem;
        font-size: 1rem;
        color: var(--grey-dark);
        min-height: 1.2em;
      }

      /* --- Voice Button --- */
      #voice-mode {
        display: flex; /* Changed from 'grid' */
        flex-direction: column;
        align-items: center;
      }
      #recordButton {
        font-size: 2rem;
        width: 100px;
        height: 100px;
        border-radius: 50%;
        border: none;
        cursor: pointer;
        background: var(--blue);
        color: white;
        transition: all 0.2s ease;
        user-select: none;
        display: grid;
        place-items: center;
      }
      #recordButton.recording {
        background: var(--red);
        animation: pulse 1.2s infinite ease-in-out;
      }
      @keyframes pulse {
        0% {
          box-shadow: 0 0 0 0 rgba(255, 59, 48, 0.7);
        }
        70% {
          box-shadow: 0 0 0 20px rgba(255, 59, 48, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(255, 59, 48, 0);
        }
      }

      /* --- Text Input --- */
      #text-mode {
        display: none; /* Hidden by default */
        width: 100%;
      }
      #textInput {
        width: 100%;
        box-sizing: border-box; /* Important */
        font-size: 1rem;
        padding: 12px 15px;
        border: 1px solid #d1d1d6;
        border-radius: 8px;
        margin-bottom: 1rem;
      }
      #sendButton {
        font-size: 1rem;
        padding: 12px 20px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        background: var(--blue);
        color: white;
        width: 100%;
      }

      /* --- Toggle --- */
      #toggle-container {
        margin-top: 2rem;
      }
      #toggleButton {
        font-size: 0.9rem;
        color: var(--blue);
        background: none;
        border: none;
        cursor: pointer;
      }

      /* --- Spinner --- */
      .loader {
        display: none; /* Hidden by default */
        width: 50px;
        height: 50px;
        border: 5px solid var(--grey-light);
        border-bottom-color: var(--blue);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 25px auto; /* Replaces the button */
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Arc Voice Pay</h1>
      <p id="status">Hold the button to speak</p>

      <div id="voice-mode">
        <button id="recordButton">
          <svg
            width="40"
            height="40"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            style="color: white"
          >
            <path
              d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"
            ></path>
            <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
            <line x1="12" y1="19" x2="12" y2="23"></line>
          </svg>
        </button>
      </div>

      <div id="text-mode">
        <input
          type="text"
          id="textInput"
          placeholder="e.g., send 2 USDC to @coolstreamer"
        />
        <button id="sendButton">Send Payment</button>
      </div>

      <div class="loader" id="loader"></div>

      <div id="toggle-container">
        <button id="toggleButton">Type it instead</button>
      </div>
    </div>

    <script>
      // --- Get all our HTML elements ---
      const recordButton = document.getElementById("recordButton");
      const sendButton = document.getElementById("sendButton");
      const textInput = document.getElementById("textInput");
      const status = document.getElementById("status");
      const loader = document.getElementById("loader");
      const voiceMode = document.getElementById("voice-mode");
      const textMode = document.getElementById("text-mode");
      const toggleButton = document.getElementById("toggleButton");

      let mediaRecorder = null;
      let audioChunks = [];
      let isTextMode = false;

      // --- Core API Functions ---

      /**
       * 1. Sends data (audio or text) to the /voice endpoint
       */
      async function sendData(formData) {
        // Show spinner, hide inputs
        setLoadingState(true);
        status.textContent = "Processing...";

        try {
          const response = await fetch("/voice", {
            method: "POST",
            body: formData,
          });

          const responseAudioBlob = await response.blob();
          playAudio(responseAudioBlob);

          if (!response.ok) {
            status.textContent = "Error from server. Try again.";
          } else {
            status.textContent = isTextMode
              ? "Type your command"
              : "Hold the button to speak";
          }
        } catch (err) {
          console.error("Error sending data:", err);
          status.textContent = "Error. Please try again.";
        } finally {
          // Hide spinner, show inputs
          setLoadingState(false);
          audioChunks = []; // Clear chunks for next recording
        }
      }

      /**
       * 2. Plays an audio blob
       */
      function playAudio(blob) {
        const audioUrl = URL.createObjectURL(blob);
        const audio = new Audio(audioUrl);
        audio.play();
        audio.onended = () => {
          URL.revokeObjectURL(audioUrl); // Clean up
        };
      }

      /**
       * 3. Toggles the UI between loading and active
       */
      function setLoadingState(isLoading) {
        loader.style.display = isLoading ? "block" : "none";
        if (isTextMode) {
          textMode.style.display = isLoading ? "none" : "block";
        } else {
          voiceMode.style.display = isLoading ? "none" : "flex";
        }
      }

      // --- Event Listeners ---

      // --- 1. Voice Recording (Hold to Talk) ---
      recordButton.addEventListener("mousedown", async () => {
        if (mediaRecorder && mediaRecorder.state === "recording") return;

        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            audio: true,
          });
          mediaRecorder = new MediaRecorder(stream, { mimeType: "audio/webm" });

          mediaRecorder.addEventListener("dataavailable", (event) => {
            audioChunks.push(event.data);
          });

          mediaRecorder.addEventListener("stop", () => {
            // Stop all mic tracks
            stream.getTracks().forEach((track) => track.stop());

            // Create audio blob and send
            const audioBlob = new Blob(audioChunks, { type: "audio/webm" });
            const formData = new FormData();
            formData.append("audio", audioBlob, "recording.webm");
            sendData(formData);
          });

          mediaRecorder.start();
          status.textContent = "Recording...";
          recordButton.classList.add("recording");
        } catch (err) {
          console.error("Error getting mic:", err);
          status.textContent = "Could not access microphone.";
        }
      });

      recordButton.addEventListener("mouseup", () => {
        if (mediaRecorder && mediaRecorder.state === "recording") {
          mediaRecorder.stop();
          recordButton.classList.remove("recording");
        }
      });

      recordButton.addEventListener("mouseleave", () => {
        if (mediaRecorder && mediaRecorder.state === "recording") {
          mediaRecorder.stop();
          recordButton.classList.remove("recording");
        }
      });

      // --- 2. Text Input (Send Button) ---
      sendButton.addEventListener("click", () => {
        const text = textInput.value;
        if (!text) {
          status.textContent = "Please type a command first.";
          return;
        }

        const formData = new FormData();
        formData.append("text", text);
        sendData(formData);
        textInput.value = ""; // Clear input
      });

      // --- 3. Toggle Button (Switch UI) ---
      toggleButton.addEventListener("click", () => {
        isTextMode = !isTextMode;
        if (isTextMode) {
          voiceMode.style.display = "none";
          textMode.style.display = "block";
          toggleButton.textContent = "Use voice instead";
          status.textContent = "Type your command";
        } else {
          voiceMode.style.display = "flex";
          textMode.style.display = "none";
          toggleButton.textContent = "Type it instead";
          status.textContent = "Hold the button to speak";
        }
      });
    </script>
  </body>
</html>
